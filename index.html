<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>iDRAC RACADM Script Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --panel:#0b1020; --border:#1f2937; --good:#22c55e; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    header { padding:1rem 1.25rem; background:#111827; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:1; }
    h1 { margin:0; font-size:1.1rem; }
    main { max-width:1100px; margin:0 auto; padding:1rem; display:grid; gap:1rem; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:10px; }
    .card h2 { margin:0; padding:0.75rem 1rem; border-bottom:1px solid var(--border); font-size:1rem; color:var(--muted); }
    .content { padding:1rem; }
    .grid { display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); }
    label { display:grid; gap:0.35rem; font-size:0.9rem; color:var(--muted); }
    input[type="text"], input[type="password"], select, textarea {
      width:100%; background:#0a1222; color:var(--fg); border:1px solid var(--border);
      border-radius:8px; padding:0.6rem 0.7rem; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .row { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; }
    .btnbar { display:flex; gap:0.5rem; flex-wrap:wrap; }
    button { background:#0a1222; border:1px solid var(--border); border-radius:8px; color:#fff; padding:0.55rem 0.8rem; cursor:pointer; }
    button.primary { background:var(--accent); color:#06131b; border-color:#0ea5e9; }
    button.good { background:var(--good); color:#062612; border-color:#16a34a; }
    pre { margin:0; white-space:pre; overflow:auto; max-height:520px; background:#071020; border:1px solid var(--border); border-radius:8px; padding:1rem; }
    .hint { color:var(--muted); font-size:0.9rem; }
    .pill { display:inline-block; background:#0a1222; border:1px solid var(--border); border-radius:999px; padding:0.2rem 0.5rem; margin-left:0.5rem; font-size:0.8rem; color:var(--muted); }
    .warning { background:#1f2937; border-left:4px solid #f59e0b; padding:0.75rem; border-radius:6px; color:#fde68a; }

    /* === Validation UI === */
    .error { color:#fca5a5; font-size:0.85rem; display:none; }
    input.invalid, select.invalid { border-color:#f87171; box-shadow:0 0 0 1px #f87171 inset; }
    .error.show { display:block; }

    /* === Summary === */
    .summary-title { margin:0 0 .5rem 0; color:var(--muted); font-size:0.95rem; }
    .summary-list { list-style:none; padding-left:0; margin:0 0 1rem 0;
      display:grid; gap:.5rem; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
    .summary-list li { background:#0a1222; border:1px solid var(--border); border-radius:8px; padding:.5rem .6rem; color:var(--fg); }
    .summary-list code { color:var(--fg); }
  </style>
</head>
<body>
<header>
  <h1>iDRAC RACADM Script Generator <span class="pill">static · GitHub Pages‑friendly</span></h1>
</header>

<main>
  <section class="card">
    <h2>1) Inputs</h2>
    <div class="content">
      <div class="warning">
        <strong>Security note:</strong> You can avoid embedding passwords in the script. Enable
        <em>Prompt for password at runtime</em> to use <code>Read-Host -AsSecureString</code> and a temporary plain text conversion.
      </div>

      <div class="grid" style="margin-top:0.75rem">
        <label>iDRAC authentication username
          <input id="u" type="text" placeholder="e.g., root" value="root" />
          <span class="error" id="err-u"></span>
        </label>
        <label>iDRAC authentication password
          <input id="p" type="password" placeholder="e.g., calvin" value="calvin" />
          <span class="error" id="err-p"></span>
        </label>
        <label>Temporary iDRAC connection IP
          <input id="ip" type="text" placeholder="e.g., 169.254.0.3" value="169.254.0.3" data-validate="ipv4" />
          <span class="error" id="err-ip">Enter a valid IPv4 address (e.g., 192.168.1.10).</span>
        </label>
        <label>Hostname
          <input id="hostname" type="text" placeholder="e.g., USFLWDRE1ASHM01" value="USFLWDRE1ASHM01" data-validate="hostname" />
          <span class="error" id="err-hostname">Hostname must be RFC‑1123 compliant (a–z, 0–9, hyphens; 1–63 chars per label; no leading/trailing hyphen).</span>
        </label>
        <label>iDRAC static IP
          <input id="idracip" type="text" placeholder="e.g., 10.184.52.51" value="10.184.52.51" data-validate="ipv4" />
          <span class="error" id="err-idracip">Enter a valid IPv4 address.</span>
        </label>
        <label>iDRAC gateway
          <input id="idracgw" type="text" placeholder="e.g., 10.184.52.1" value="10.184.52.1" data-validate="ipv4" />
          <span class="error" id="err-idracgw">Enter a valid IPv4 gateway.</span>
        </label>
        <label>iDRAC netmask
          <input id="idracmask" type="text" placeholder="e.g., 255.255.255.0" value="255.255.255.0" data-validate="netmask" />
          <span class="error" id="err-idracmask">Enter a valid subnet mask (e.g., 255.255.255.0).</span>
        </label>
        <label>DNS1
          <input id="idracdns1" type="text" placeholder="e.g., 10.110.30.216" value="10.110.30.216" data-validate="ipv4" />
          <span class="error" id="err-idracdns1">Enter a valid IPv4 DNS server.</span>
        </label>

        <!-- DNS2 (optional) -->
        <label>DNS2
          <input id="idracdns2" type="text" placeholder="e.g., 10.110.93.254"
                 value=""
                 data-validate="ipv4" data-optional="true" />
          <span class="error" id="err-idracdns2">Enter a valid IPv4 DNS server (or leave blank).</span>
        </label>

        <label>NTP1
          <input id="idracntp1" type="text" placeholder="e.g., 10.110.30.216" value="10.110.30.216" data-validate="ipv4" />
          <span class="error" id="err-idracntp1">Enter a valid IPv4 NTP server.</span>
        </label>

        <!-- NTP2 (optional) -->
        <label>NTP2
          <input id="idracntp2" type="text" placeholder="e.g., 10.110.93.254"
                 value=""
                 data-validate="ipv4" data-optional="true" />
          <span class="error" id="err-idracntp2">Enter a valid IPv4 NTP server (or leave blank).</span>
        </label>

        <label>Timezone
          <select id="timezoneSelect" data-validate="timezone">
            <option value="EST5EDT" selected>US/Eastern — EST5EDT</option>
            <option value="CST6CDT">US/Central — CST6CDT</option>
            <option value="MST7MDT">US/Mountain — MST7MDT</option>
            <option value="MST7">US/Arizona (no DST) — MST7</option>
            <option value="PST8PDT">US/Pacific — PST8PDT</option>
            <option value="UTC">UTC</option>
            <option value="GMT0">GMT — GMT0</option>
            <option value="Other">Other (custom POSIX)</option>
          </select>
          <input id="timezoneCustom" type="text" placeholder="Custom POSIX TZ (e.g., CET-1CEST,M3.5.0/2,M10.5.0/3)" style="display:none;" />
          <span class="error" id="err-timezone">Pick a timezone or enter a valid POSIX TZ string.</span>
        </label>
      </div>

      <div class="row" style="margin-top:0.5rem">
        <label style="display:flex; align-items:center; gap:0.5rem; color:var(--fg);">
          <input id="promptPwd" type="checkbox" />
          Prompt for password at runtime (recommended)
        </label>
      </div>

      <!-- PSU Active option -->
      <div class="row" style="margin-top:0.25rem">
        <label style="display:flex; align-items:center; gap:0.5rem; color:var(--fg);">
          <input id="psuActive" type="checkbox" />
          Make both PSUs active
        </label>
        <div class="hint" style="margin-left:2rem; max-width:72ch;">
          <strong>Note:</strong> Some sites will have issues with power and will need to have both PSUs enabled providing power rather than the default of hot standby.
        </div>
      </div>

      <div class="btnbar" style="margin-top:0.75rem">
        <button class="primary" id="btnPreview">Preview</button>
        <button id="btnCopy" disabled>Copy</button>
        <button class="good" id="btnDownload" disabled>Download .ps1</button>
      </div>
      <p class="hint" id="validationHint" style="margin-top:0.5rem; display:none; color:#fca5a5;">
        Please fix the highlighted fields to enable Copy/Download.
      </p>
    </div>
  </section>

  <section class="card">
    <h2>2) Preview</h2>
    <div class="content">
      <h3 class="summary-title">Summary of selected options</h3>
      <ul id="summaryList" class="summary-list"></ul>

      <pre id="preview"></pre>
      <p class="hint">This builds a PowerShell script that uses <code>racadm --nocertwarn</code> with your inputs and applies iDRAC settings.</p>
    </div>
  </section>
</main>

<script>
  // ========= Utilities =========
  const CRLF = s => s.replace(/\r?\n/g, "\r\n");
  const psq = s => `'${String(s ?? "").replace(/'/g, "''")}'`; // PowerShell single-quote safe
  const $ = id => document.getElementById(id);
  const v = id => $(id).value.trim();
  const b = id => $(id).checked;
  const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // ========= Validation =========
  const IPV4_RE =
    /^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/;

  // Common subnet masks (CIDR /1 through /30)
  const VALID_NETMASKS = new Set([
    "128.0.0.0","192.0.0.0","224.0.0.0","240.0.0.0","248.0.0.0","252.0.0.0","254.0.0.0",
    "255.0.0.0","255.128.0.0","255.192.0.0","255.224.0.0","255.240.0.0","255.248.0.0",
    "255.252.0.0","255.254.0.0","255.255.0.0","255.255.128.0","255.255.192.0","255.255.224.0",
    "255.255.240.0","255.255.248.0","255.255.252.0","255.255.254.0","255.255.255.0",
    "255.255.255.128","255.255.255.192","255.255.255.224","255.255.255.240",
    "255.255.255.248","255.255.255.252"
  ]);

  function isValidIPv4(s) { return IPV4_RE.test(s); }
  function isValidNetmask(s) { return VALID_NETMASKS.has(s); }

  // RFC‑1035/1123 hostname check
  function isValidHostname(name) {
    if (!name || name.length > 253) return false;
    const labels = name.split(".");
    for (const label of labels) {
      if (label.length < 1 || label.length > 63) return false;
      // must start with alnum, may contain hyphens, must end with alnum
      if (!/^[A-Za-z0-9](?:[A-Za-z0-9-]*[A-Za-z0-9])?$/.test(label)) return false;
    }
    return true;
  }

  // Permissive POSIX TZ token check (for custom)
  function isValidPosixTz(s) { return /^[A-Za-z][A-Za-z0-9+\-:_.,/]{0,63}$/.test(s); }

  function setFieldState(el, valid, errEl) {
    el.classList.toggle("invalid", !valid);
    el.setAttribute("aria-invalid", String(!valid));
    if (errEl) errEl.classList.toggle("show", !valid);
  }

  function validateField(input) {
    const type = input.dataset.validate;
    const optional = input.dataset.optional === "true";
    const value = input.value.trim();
    let valid = true;

    if (type === "ipv4") {
      valid = optional && value === "" ? true : isValidIPv4(value);
    } else if (type === "netmask") {
      valid = isValidNetmask(value);
    } else if (type === "hostname") {
      valid = isValidHostname(value);
    } else if (type === "timezone") {
      valid = validateTimezone(); // handles its own UI state
      return valid;
    }

    const err = input.nextElementSibling && input.nextElementSibling.classList.contains("error")
      ? input.nextElementSibling
      : null;
    setFieldState(input, valid, err);
    return valid;
  }

  function validateTimezone() {
    const sel = $("timezoneSelect");
    const custom = $("timezoneCustom");
    const err = $("err-timezone");
    let valid = true;

    if (sel.value === "Other") {
      const val = custom.value.trim();
      valid = isValidPosixTz(val);
      setFieldState(custom, valid, err);
      setFieldState(sel, valid, null); // highlight both on error
    } else {
      setFieldState(sel, true, null);
      setFieldState(custom, true, err);
    }
    return valid;
  }

  function validateAll() {
    const inputs = document.querySelectorAll('input[data-validate], select[data-validate]');
    let allValid = true;
    inputs.forEach(inp => {
      const ok = validateField(inp);
      if (!ok) allValid = false;
    });
    $("btnCopy").disabled = !allValid;
    $("btnDownload").disabled = !allValid;
    $("validationHint").style.display = allValid ? "none" : "block";
    return allValid;
  }

  // ========= Timezone helper =========
  function currentTimezoneValue() {
    const sel = $("timezoneSelect").value;
    if (sel === "Other") {
      const custom = v("timezoneCustom");
      return custom || "EST5EDT";
    }
    return sel;
  }

  // ========= Script builder =========
  function buildScript() {
    const u = v('u');
    const p = v('p');
    const ip = v('ip');
    const hostname = v('hostname');
    const idracip = v('idracip');
    const idracgw = v('idracgw');
    const idracmask = v('idracmask');
    const idracdns1 = v('idracdns1');
    const idracdns2Raw = v('idracdns2'); // optional
    const idracntp1 = v('idracntp1');
    const idracntp2Raw = v('idracntp2'); // optional
    const timezone = currentTimezoneValue();
    const promptPwd = b('promptPwd');

    // Defensive normalization for optional fields
    const idracdns2 = idracdns2Raw.trim();
    const idracntp2 = idracntp2Raw.trim();

    const header = [
      "# ================================================",
      "# Generated iDRAC RACADM configuration script",
      `# Generated: ${new Date().toISOString()}`,
      "# ================================================",
      "$ErrorActionPreference = 'Stop'",
      "Set-StrictMode -Version Latest",
      ""
    ];

    // Build variables (omit DNS2/NTP2 variable lines when blank)
    const credLines = [];
    credLines.push(`$u = ${psq(u || 'root')}`);
    if (promptPwd) {
      credLines.push(
        `$secureP = Read-Host "Enter iDRAC password for $u" -AsSecureString`,
        `$p = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($secureP))`
      );
    } else {
      credLines.push(`$p = ${psq(p || 'calvin')}`);
    }
    credLines.push(`$ip = ${psq(ip || '169.254.0.3')}`);
    credLines.push(`$hostname = ${psq(hostname || 'idrac-host')}`);
    credLines.push(`$idracip = ${psq(idracip || '')}`);
    credLines.push(`$idracgw = ${psq(idracgw || '')}`);
    credLines.push(`$idracmask = ${psq(idracmask || '')}`);
    credLines.push(`$idracdns1 = ${psq(idracdns1 || '')}`);
    if (idracdns2 && isValidIPv4(idracdns2)) credLines.push(`$idracdns2 = ${psq(idracdns2)}`);
    credLines.push(`$idracntp1 = ${psq(idracntp1 || '')}`);
    if (idracntp2 && isValidIPv4(idracntp2)) credLines.push(`$idracntp2 = ${psq(idracntp2)}`);
    credLines.push(`$timezone = ${psq(timezone || 'EST5EDT')}`);
    credLines.push("");

    // racadm commands (omit DNS2/NTP2 when blank)
    const body = [];
    body.push(`# Disable default credential warning`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.Tuning.DefaultCredentialWarning 0`);

    body.push(`# Disable DHCP and enable IPv4`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ipv4.dhcpenable 0`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ipv4.enable enable`);

    body.push(`# Apply IPv4 settings`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ipv4.gateway $idracgw`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ipv4.address $idracip`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ipv4.netmask $idracmask`);

    body.push(`# Enable IPMI over LAN`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ipmilan.enable enabled`);

    body.push(`# Set DNS host name and DNS servers`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.nic.dnsracname $hostname`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ipv4.DNS1 $idracdns1`);
    if (idracdns2 && isValidIPv4(idracdns2)) {
      body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ipv4.DNS2 $idracdns2`);
    }

    body.push(`# Timezone and NTP`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.time.timezone $timezone`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ntpconfiggroup.ntp1 $idracntp1`);
    if (idracntp2 && isValidIPv4(idracntp2)) {
      body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ntpconfiggroup.ntp2 $idracntp2`);
    }
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p set idrac.ntpconfiggroup.ntpenable 1`);

    // PSU Active option
    if (b('psuActive')) {
      body.push(`# Make both PSUs active`);
      body.push(`# Some sites require both PSUs providing power instead of hot standby`);
      body.push(`racadm --nocertwarn -r $ip -u $u -p $p set system.serverpwr.PSRedPolicy 0`);
      body.push(`racadm --nocertwarn -r $ip -u $u -p $p set system.serverpwr.PSRapidOn Disabled`);
    }

    body.push(`# Show final IPv4 config`);
    body.push(`racadm --nocertwarn -r $ip -u $u -p $p get idrac.ipv4`);

    if (promptPwd) {
      body.push(
        ``,
        `# Cleanup plaintext password variable`,
        `Remove-Variable -Name p -ErrorAction SilentlyContinue`
      );
    }

    return [...header, ...credLines, ...body, ""].join("\n");
  }

  // ========= Summary builder =========
  function buildSummary() {
    const ip = v('ip');
    const hostname = v('hostname');
    const idracip = v('idracip');
    const idracgw = v('idracgw');
    const idracmask = v('idracmask');
    const idracdns1 = v('idracdns1');
    const idracdns2 = v('idracdns2').trim();
    const idracntp1 = v('idracntp1');
    const idracntp2 = v('idracntp2').trim();
    const tz = currentTimezoneValue();
    const pwdMode = b('promptPwd') ? 'Prompt at runtime' : 'Embedded in script (not recommended)';
    const psuMode = b('psuActive') ? 'Both PSUs active' : 'Default hot standby';

    const items = [
      `<li><strong>Temp iDRAC IP:</strong> <code>${esc(ip)}</code></li>`,
      `<li><strong>Hostname:</strong> <code>${esc(hostname)}</code></li>`,
      `<li><strong>Static IP:</strong> <code>${esc(idracip)}</code></li>`,
      `<li><strong>Gateway:</strong> <code>${esc(idracgw)}</code></li>`,
      `<li><strong>Netmask:</strong> <code>${esc(idracmask)}</code></li>`,
      `<li><strong>DNS1:</strong> <code>${esc(idracdns1)}</code></li>`,
      `<li><strong>NTP1:</strong> <code>${esc(idracntp1)}</code></li>`,
      `<li><strong>Timezone:</strong> <code>${esc(tz)}</code></li>`,
      `<li><strong>Password handling:</strong> ${esc(pwdMode)}</li>`,
      `<li><strong>PSU mode:</strong> ${esc(psuMode)}</li>`
    ];
    if (idracdns2) items.splice(6, 0, `<li><strong>DNS2:</strong> <code>${esc(idracdns2)}</code></li>`);
    if (idracntp2) items.splice(8, 0, `<li><strong>NTP2:</strong> <code>${esc(idracntp2)}</code></li>`);

    $("summaryList").innerHTML = items.join("");
  }

  // ========= UI glue =========
  function updatePreview() {
    validateAll();
    const script = buildScript();
    $("preview").textContent = script;
    buildSummary();

    const tooShort = script.trim().length < 10;
    $("btnCopy").disabled = $("btnCopy").disabled || tooShort;
    $("btnDownload").disabled = $("btnDownload").disabled || tooShort;
  }

  function downloadPs1() {
    const content = CRLF(buildScript());
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "idrac-racadm-config.ps1";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function copyToClipboard() {
    await navigator.clipboard.writeText(buildScript());
    const btn = $("btnCopy");
    const prev = btn.textContent;
    btn.textContent = "Copied!";
    setTimeout(() => btn.textContent = prev, 1200);
  }

  // Wire up
  $("btnPreview").addEventListener("click", updatePreview);
  $("btnDownload").addEventListener("click", downloadPs1);
  $("btnCopy").addEventListener("click", copyToClipboard);

  // Real-time validation & live preview updates
  document.querySelectorAll("input").forEach(el => {
    el.addEventListener("input", e => {
      if (e.target.matches('input[data-validate]')) validateField(e.target);
      updatePreview();
    });
    el.addEventListener("change", updatePreview); // ensure checkboxes trigger preview/summary
  });
  document.querySelectorAll("select").forEach(el => {
    el.addEventListener("change", e => {
      if (e.target.id === "timezoneSelect") {
        const custom = $("timezoneCustom");
        custom.style.display = e.target.value === "Other" ? "" : "none";
      }
      if (e.target.matches('select[data-validate]')) validateField(e.target);
      updatePreview();
    });
  });
  $("timezoneCustom").addEventListener("input", () => { validateTimezone(); updatePreview(); });

  // Initial render
  updatePreview();
</script>
</body>
</html>
